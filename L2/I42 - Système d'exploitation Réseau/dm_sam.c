#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <wait.h>
#include <time.h>
#include <signal.h>
#include <errno.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/sem.h>
#include <sys/shm.h>
#include <sys/msg.h>



struct sembuf Sem[1];//Initialization du sembuf


int* cpt_a; //compteur
int* cpt_d; //compteur

/*exo1_tp7*/

void initSem(int* semID, int* memDEC, int* memATT){ //Initialization du Semaphore
  *semID = semget(ftok("dm_sam.c", (key_t)3),1,0750|IPC_CREAT); //générer un sémaphore (semID)
  if(semID!=0){
    semctl(*semID,0,SETVAL,0); //valeur sémaphore = 0
  }
  *memDEC = shmget(ftok("dm_sam.c",(key_t)2),sizeof(int),0750|IPC_CREAT); //mémoire nb passagers décollage
  *memATT = shmget(ftok("dm_sam.c",(key_t)1),sizeof(int),0750|IPC_CREAT); //mémoire nb passagers atterissage

  cpt_d = (int*)shmat(*memDEC, 0, 0); //On relie le ID de la mémoire partagée
  cpt_a = (int*)shmat(*memATT, 0, 0); //On relie le ID de la mémoire partagée
}

void P(int semID){ //Demande token
  Sem[0].sem_num = 0;
  Sem[0].sem_op = -1;
  semop(semID, Sem, 1);
}

void V(int semID){ //Renvoei token
  Sem[0].sem_num = 0;
  Sem[0].sem_op = -1;
  semop(semID, Sem, 1);
}

/*exo2_tp7*/

void fly(int f){ //Fonction de Décollage
  printf("Vol numéro %d en phase de décollage\n", f);
  sleep(5);
}

void lland(int f){ //Fonction d'Atterrissage
  printf("Vol numéro %d en phase d'atterrissage\n", f);
  sleep(3);
}



int main(int argc, char* argv[]){
  int Sem, test_T, test_L, passengers, land, v;
  int landing_planes = atoi(argv[2]); //avions qui attérrissent
  int n = atoi(argv[1]) + atoi(argv[2]); //nb total d'avions
  int *pid;
  pid = (int*)malloc(sizeof(int)*n);
  int fils = fork();
  land = (rand()%10); //Attendre au plus 10 s avant d'atterrir
  passengers = rand() % 301; //301 passagers



  *cpt_a = 0;
  *cpt_d = 0;

  srand(time(NULL));
  initSem(&Sem, &test_T, &test_L);


  for(int i = 0; i < n; i++){
    if(fils == 0){ //PROCESSUS
      srand(time(NULL)* getpid());
      pid[i] = getpid();

      v = (i < landing_planes);
      switch (v) {
        case 0: //PHASE D'ATTERRISSAGE
          sleep(land);
          printf("Vol numéro %d de %d passagers souhaite atterrir\n", pid[i], passengers);
          P(Sem);
          *cpt_a += passengers;
          lland(pid[i]);
          printf("Piste liberée par vol numéro %d\n", pid[i]);
          V(Sem);
          break;

        case 1: //PHASE DE DECOLLAGE
          sleep(land);
          printf("Vol numero %d de %d passagers souhaite décoller\n", pid[i], passengers);
          P(Sem);
          *cpt_d += passengers;
          fly(pid[i]);
          printf("Piste libérée par vol numéro %d", pid[i]);
          V(Sem);
          break;
      }


      fflush(stdout);
    }
    exit(5);
  }

  semctl(Sem,0,SETVAL,1); //Semaphore à 0
  fflush(stdout);

  printf("Fin de journée\n");
  printf("Nombre de passagers arrivants : %d\n", *cpt_a);
  printf("Nombre de passagers partants : %d\n", *cpt_d);
}
